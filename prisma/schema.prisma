// Prisma schema for Community Sauna
// Using MySQL provider (compatible with MariaDB)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// Enums
enum UserRole {
  member
  host
  admin
  superadmin
}

enum Gender {
  male
  female
  non_binary
  other
  prefer_not_to_say
}

enum MembershipPlanType {
  subscription
  punch_card
}

enum MembershipStatus {
  active
  expired
  payment_pending
  suspended
  cancelled
}

enum PaymentStatus {
  pending
  succeeded
  failed
  refunded
}

enum BookingStatus {
  confirmed
  cancelled
  no_show
}

enum Weekday {
  mon
  tue
  wed
  thu
  fri
  sat
  sun
}

enum NotificationType {
  booking_confirmation
  booking_reminder
  booking_cancelled
  membership_expiring
  announcement
}

// Models

model User {
  id                     Int       @id @default(autoincrement())
  email                  String    @unique @db.VarChar(255)
  passwordHash           String    @map("password_hash") @db.VarChar(255)
  firstName              String    @map("first_name") @db.VarChar(100)
  lastName               String?   @map("last_name") @db.VarChar(100)
  phone                  String    @db.VarChar(20)
  gender                 Gender?
  emergencyContactName   String?   @map("emergency_contact_name") @db.VarChar(200)
  emergencyContactPhone  String?   @map("emergency_contact_phone") @db.VarChar(20)
  role                   UserRole  @default(member)
  createdAt              DateTime  @default(now()) @map("created_at")
  updatedAt              DateTime  @updatedAt @map("updated_at")

  // Relations
  memberships   Membership[]
  bookings      Booking[]
  payments      Payment[]
  notifications Notification[]
  articles      Article[]
  hostedSlots   TimeSlot[]     @relation("HostedSlots")

  @@map("users")
}

model MembershipPlan {
  id                      Int                @id @default(autoincrement())
  name                    String             @db.VarChar(100)
  description             String             @db.Text
  type                    MembershipPlanType
  priceCents              Int                @map("price_cents")
  creditsPerMonth         Int?               @map("credits_per_month")
  totalCredits            Int?               @map("total_credits")
  validityMonths          Int?               @map("validity_months")
  minimumCommitmentMonths Int?               @map("minimum_commitment_months")
  autoRenew               Boolean            @default(false) @map("auto_renew")
  isActive                Boolean            @default(true) @map("is_active")
  createdAt               DateTime           @default(now()) @map("created_at")
  updatedAt               DateTime           @updatedAt @map("updated_at")

  // Relations
  memberships Membership[]

  @@map("membership_plans")
}

model Membership {
  id                      Int              @id @default(autoincrement())
  userId                  Int              @map("user_id")
  membershipPlanId        Int              @map("membership_plan_id")
  status                  MembershipStatus @default(active)
  startsAt                DateTime         @map("starts_at") @db.Date
  expiresAt               DateTime?        @map("expires_at") @db.Date
  cancelledAt             DateTime?        @map("cancelled_at") @db.Date
  cancellationEffectiveAt DateTime?        @map("cancellation_effective_at") @db.Date
  notes                   String?          @db.Text
  createdAt               DateTime         @default(now()) @map("created_at")
  updatedAt               DateTime         @updatedAt @map("updated_at")

  // Relations
  user           User           @relation(fields: [userId], references: [id])
  membershipPlan MembershipPlan @relation(fields: [membershipPlanId], references: [id])
  payments       Payment[]
  bookings       Booking[]

  @@map("memberships")
}

model Payment {
  id                Int           @id @default(autoincrement())
  userId            Int           @map("user_id")
  membershipId      Int?          @map("membership_id")
  bookingId         Int?          @unique @map("booking_id")
  amountCents       Int           @map("amount_cents")
  status            PaymentStatus @default(pending)
  provider          String        @db.VarChar(50)
  providerPaymentId String?       @map("provider_payment_id") @db.VarChar(255)
  createdAt         DateTime      @default(now()) @map("created_at")
  updatedAt         DateTime      @updatedAt @map("updated_at")

  // Relations
  user       User        @relation(fields: [userId], references: [id])
  membership Membership? @relation(fields: [membershipId], references: [id])
  booking    Booking?    @relation(fields: [bookingId], references: [id])

  @@map("payments")
}

model ScheduleTemplate {
  id        Int            @id @default(autoincrement())
  name      String         @db.VarChar(100)
  createdAt DateTime       @default(now()) @map("created_at")
  updatedAt DateTime       @updatedAt @map("updated_at")

  // Relations
  slots TemplateSlot[]

  @@map("schedule_templates")
}

model TemplateSlot {
  id          Int              @id @default(autoincrement())
  templateId  Int              @map("template_id")
  weekday     Weekday
  startTime   DateTime         @map("start_time") @db.Time(0)
  endTime     DateTime         @map("end_time") @db.Time(0)
  capacity    Int
  type        String?          @db.VarChar(100)
  description String?          @db.Text

  // Relations
  template ScheduleTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  @@map("template_slots")
}

model TimeSlot {
  id          Int       @id @default(autoincrement())
  hostId      Int?      @map("host_id")
  date        DateTime  @db.Date
  startTime   DateTime  @map("start_time") @db.Time(0)
  endTime     DateTime  @map("end_time") @db.Time(0)
  capacity    Int       @default(5)
  type        String?   @db.VarChar(100)
  description String?   @db.Text
  isCancelled Boolean   @default(false) @map("is_cancelled")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  // Relations
  host     User?     @relation("HostedSlots", fields: [hostId], references: [id])
  bookings Booking[]

  @@map("time_slots")
}

model Booking {
  id                 Int           @id @default(autoincrement())
  userId             Int           @map("user_id")
  timeslotId         Int           @map("timeslot_id")
  membershipId       Int?          @map("membership_id")
  status             BookingStatus @default(confirmed)
  cancelledAt        DateTime?     @map("cancelled_at")
  cancellationReason String?       @map("cancellation_reason") @db.Text
  createdAt          DateTime      @default(now()) @map("created_at")
  updatedAt          DateTime      @updatedAt @map("updated_at")

  // Relations
  user       User        @relation(fields: [userId], references: [id])
  timeslot   TimeSlot    @relation(fields: [timeslotId], references: [id])
  membership Membership? @relation(fields: [membershipId], references: [id])
  payment    Payment?

  @@unique([userId, timeslotId])
  @@map("bookings")
}

model Article {
  id          Int       @id @default(autoincrement())
  authorId    Int       @map("author_id")
  title       String    @db.VarChar(255)
  content     String    @db.Text
  isPublished Boolean   @default(false) @map("is_published")
  publishedAt DateTime? @map("published_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  // Relations
  author User @relation(fields: [authorId], references: [id])

  @@map("articles")
}

model Notification {
  id        Int              @id @default(autoincrement())
  userId    Int              @map("user_id")
  type      NotificationType
  title     String           @db.VarChar(255)
  message   String           @db.Text
  isRead    Boolean          @default(false) @map("is_read")
  sentAt    DateTime         @map("sent_at")
  createdAt DateTime         @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id])

  @@map("notifications")
}
